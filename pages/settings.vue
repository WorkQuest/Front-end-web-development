<template>
  <div class="settings">
    <div class="settings__title">
      {{ $t('settings.settings') }}
    </div>
    <ValidationObserver
      ref="settings"
      class="settings__body"
      tag="div"
    >
      <verification-card v-if="userRole === UserRole.WORKER && isShowInfo === true && userData.statusKYC === 0" />
      <profile
        :profile="profile"
        :new-education="newEducation"
        :new-work-exp="newWorkExp"
        :avatar-change="avatarChange"
        :validation-error="validationError"
        :is-valid-phone-number="isValidPhoneNumber"
        @click="editUserData"
        @updateFirstPhone="updateFirstPhone($event)"
        @updateSecondPhone="updateSecondPhone($event)"
        @showModalStatus="showModalStatus"
        @checkValidate="checkValidate"
        @updateEducation="addEducation"
        @updateCoordinates="updateCoordinates"
        @validationRef="validationRefs"
      />
      <skills
        v-if="userRole === UserRole.WORKER"
        :skills="skills"
        :validation-error="validationError"
        @click="editUserData"
        @checkValidate="checkValidate"
      />
      <advanced @showModalKey="showModalKey" />
    </ValidationObserver>
  </div>
</template>

<script>
import { mapGetters } from 'vuex';
import modals from '~/store/modals/modals';
import 'vue-phone-number-input/dist/vue-phone-number-input.css';
import VerificationCard from '~/components/app/pages/settings/VerificationCard.vue';
import Profile from '~/components/app/pages/settings/Profile.vue';
import Skills from '~/components/app/pages/settings/Skills.vue';
import Advanced from '~/components/app/pages/settings/Advanced.vue';
import { UserRole, WorkplaceIndex } from '~/utils/enums';

export default {
  name: 'Settings',
  components: {
    VerificationCard, Profile, Skills, Advanced,
  },
  data() {
    return {
      profile: {
        avatarId: null,
        firstName: null,
        lastName: null,
        skillFilters: null,
        firstPhone: { codeRegion: null, phone: null, fullPhone: null },
        tempPhone: { codeRegion: null, phone: null, fullPhone: null },
        additionalInfo: {
          secondMobileNumber: { codeRegion: null, phone: null, fullPhone: null },
          address: null,
          socialNetwork: {
            instagram: null,
            twitter: null,
            linkedin: null,
            facebook: null,
          },
          description: null,
          skills: [],
          educations: [],
          workExperiences: [],
          CEO: null,
          company: null,
          website: null,
        },
        locationFull: {
          location: {
            longitude: 0,
            latitude: 0,
          },
          locationPlaceName: '',
        },
      },
      skills: {
        perHour: 0,
        priorityIndex: -1,
        distantIndex: -1,
        selectedSpecAndSkills: null,
      },
      isShowInfo: true,
      avatarChange: { data: {}, file: {} },
      updatedSecondPhone: { codeRegion: null, phone: null, fullPhone: null },
      updatedFirstPhone: { codeRegion: null, phone: null, fullPhone: null },
      validationError: false,
      isValidPhoneNumber: true,
      newEducation: [],
      newWorkExp: [],
      valRefs: {},
    };
  },
  computed: {
    ...mapGetters({
      userRole: 'user/getUserRole',
      userData: 'user/getUserData',
      accessToken: 'sumsub/getSumSubBackendToken',
      filters: 'quests/getFilters',
      secondNumber: 'user/getUserSecondMobileNumber',
    }),
    WorkplaceIndex() {
      return WorkplaceIndex;
    },
    UserRole() {
      return UserRole;
    },
  },
  async mounted() {
    this.SetLoader(true);
    if (!this.filters) await this.$store.dispatch('quests/getFilters');
    if (!this.profile.firstName) await this.$store.dispatch('user/getUserData');
    const addInfo = this.userData.additionalInfo;
    this.profile = {
      avatarId: this.userData.avatarId,
      firstName: this.userData.firstName,
      lastName: this.userData.lastName,
      email: this.userData.email,
      firstPhone: {
        codeRegion: this.userData.phone?.codeRegion || this.userData.tempPhone?.codeRegion,
        phone: this.userData.phone?.phone || this.userData.tempPhone?.phone,
        fullPhone: this.userData.phone?.fullPhone || this.userData.tempPhone?.fullPhone,
      },
      additionalInfo: {
        secondMobileNumber: {
          codeRegion: this.secondNumber?.codeRegion || null,
          phone: this.secondNumber?.phone || null,
          fullPhone: this.secondNumber?.fullPhone || null,
        },
        address: addInfo.address,
        socialNetwork: {
          instagram: addInfo.socialNetwork.instagram,
          twitter: addInfo.socialNetwork.twitter,
          linkedin: addInfo.socialNetwork.linkedin,
          facebook: addInfo.socialNetwork.facebook,
        },
        description: addInfo.description,
        skills: addInfo.skills,
        educations: addInfo.educations ? addInfo.educations.slice() : [],
        workExperiences: addInfo.workExperiences ? addInfo.workExperiences.slice() : [],
        CEO: addInfo.CEO,
        company: addInfo.company,
        website: addInfo.website,
      },
      locationFull: {
        location: {
          longitude: this.coordinates?.lng || this.profile.locationFull.location?.longitude || 0,
          latitude: this.coordinates?.lat || this.profile.locationFull.location?.latitude || 0,
        },
        locationPlaceName: addInfo.address,
      },
    };
    this.skills = {
      priorityIndex: this.userData.priority,
      distantIndex: this.distantIndexByWorkplace(this.userData.workplace),
      perHour: this.userData.wagePerHour,
      selectedSpecAndSkills: this.userData.userSpecializations || [],
    };
    this.SetLoader(false);
  },
  methods: {
    validationRefs(data) {
      this.valRefs = data;
      return this.valRefs;
    },
    updateCoordinates(coordinates) {
      this.profile.locationFull.location.longitude = +coordinates.lng;
      this.profile.locationFull.location.latitude = +coordinates.lat;
      this.profile.locationFull.locationPlaceName = coordinates.address;
    },
    distantIndexByWorkplace(workplace) {
      return WorkplaceIndex[workplace];
    },
    // MODALS METHODS
    addEducation(knowledge, data) {
      const { educations, workExperiences } = this.profile.additionalInfo;
      if (knowledge === 'newEducation') {
        this.newEducation = [];
        this.newEducation.push({ ...data });
        this.profile.additionalInfo.educations = educations.concat(this.newEducation);
        console.log(this.newEducation);
      } else {
        this.newWorkExp = [];
        this.newWorkExp.push({ ...data });
        this.profile.additionalInfo.workExperiences = workExperiences.concat(this.newWorkExp);
      }
    },
    modalsStatusTitle(modalMode) {
      const titles = {
        enterPhoneNumber: this.$t('settings.enterPhoneNumber'),
        enterCurrentLocation: this.$t('settings.enterCurrentLocation'),
        imageLoadedSuccessful: this.$t('modals.imageLoadedSuccessful'),
        educationAddSuccessful: this.$t('modals.educationAddSuccessful'),
        workExpAddSuccessful: this.$t('modals.workExpAddSuccessful'),
        saved: this.$t('modals.saved'),
      };
      return titles[modalMode];
    },
    modalsStatusSubtitles(modalMode) {
      const subtitles = {
        enterPhoneNumber: this.$t('modals.pressSaveBtn'),
        enterCurrentLocation: this.$t('modals.pressSaveBtn'),
        imageLoadedSuccessful: this.$t('modals.pressSaveBtn'),
        educationAddSuccessful: this.$t('modals.pressSaveBtn'),
        workExpAddSuccessful: this.$t('modals.pressSaveBtn'),
        saved: this.$t('modals.userDataHasBeenSaved'),
      };
      return subtitles[modalMode];
    },
    modalsKey(modalKey) {
      const keys = {
        disable2FA: modals.disable2FA,
        chooseNecessarySkills: modals.chooseNecessarySkills,
        changePassInSettings: modals.changePassInSettings,
        twoFAAuth: modals.twoFAAuth,
        smsVerification: modals.smsVerification,
        changeRoleWarning: modals.changeRoleWarning,
      };
      return keys[modalKey];
    },
    showModalKey(modalKey) {
      this.ShowModal({ key: this.modalsKey(modalKey) });
    },
    showModalStatus(modalMode) {
      this.ShowModal({
        key: modals.status,
        img: require('~/assets/img/ui/questAgreed.svg'),
        title: this.modalsStatusTitle(modalMode),
        subtitle: this.modalsStatusSubtitles(modalMode),
      });
    },

    // UPDATE PHONE
    updateFirstPhone(value) {
      this.isValidPhoneNumber = value.isValid;
      this.updatedFirstPhone = {
        phone: value?.nationalNumber || null,
        fullPhone: value?.formatInternational ? value.formatInternational.replace(/\s/g, '') : null,
        codeRegion: value?.countryCode || null,
      };
    },

    updateSecondPhone(value) {
      this.isValidPhoneNumber = true;
      this.updatedSecondPhone = {
        phone: value?.nationalNumber || null,
        fullPhone: value?.formatInternational ? value.formatInternational.replace(/\s/g, '') : null,
        codeRegion: value?.countryCode || null,
      };
    },

    // UPDATE USER INFO METHODS
    async editUserData() {
      if (await this.checkValidate()) {
        this.validationError = true;
        return;
      }
      const checkAvatarID = this.avatarChange.data.ok ? this.avatarChange.data.result.mediaId : this.userData.avatarId;
      const firstMobileNumber = +this.updatedFirstPhone.fullPhone;
      await this.setAvatar();
      if (firstMobileNumber) await this.editProfile(checkAvatarID);
      if (!firstMobileNumber) this.showModalStatus('enterPhoneNumber');
    },

    async checkValidate() {
      const validateEducation = this.userRole === UserRole.EMPLOYER ? true : await this.validateKnowledge('education',
        this.newEducation.length > 0 ? this.newEducation : 'validated');
      const validateWorkExp = this.userRole === UserRole.EMPLOYER ? true : await this.validateKnowledge('work',
        this.newWorkExp.length > 0 ? this.newWorkExp : 'validated');
      const validateSettings = await this.$refs.settings.validate();
      if (!validateSettings || !validateEducation || !validateWorkExp || !this.isValidPhoneNumber) return true;
      this.validationError = false;
      return false;
    },

    async validateKnowledge(observerName, value) {
      if (value === 'validated') return true;
      const isDirty = Object.keys(value).some((field) => value[field] !== '' && value[field] !== null);
      if (observerName === 'education' && isDirty) return this.valRefs.education.validate();
      if (observerName === 'work' && isDirty) return this.valRefs.work.validate();
      return false;
    },

    async setAvatar() {
      const formData = new FormData();
      formData.append('image', this.avatarChange.file);
      if (this.avatarChange.data.ok) {
        await this.$store.dispatch('user/setImage', {
          url: this.avatarChange.data.result.url,
          formData: this.avatarChange.file,
          type: this.avatarChange.file.type,
        });
      }
    },

    editProfileRoute() {
      if (this.userRole === UserRole.WORKER) return 'editWorkerData';
      return 'editEmployerData';
    },

    async editProfile(checkAvatarID) {
      const addInfo = this.profile.additionalInfo;
      const {
        instagram, twitter, linkedin, facebook,
      } = addInfo.socialNetwork;
      const payload = {
        avatarId: checkAvatarID,
        firstName: this.profile.firstName,
        lastName: this.profile.lastName,
        phoneNumber: {
          codeRegion: this.updatedFirstPhone.codeRegion || null,
          phone: this.updatedFirstPhone.phone || null,
          fullPhone: this.updatedFirstPhone.fullPhone || null,
        },
        locationFull: {
          location: {
            longitude: this.coordinates ? this.coordinates.lng : this.profile.locationFull.location?.longitude || 0,
            latitude: this.coordinates ? this.coordinates.lat : this.profile.locationFull.location?.latitude || 0,
          },
          locationPlaceName: addInfo.address,
        },
        additionalInfo: {
          address: addInfo.address,
          secondMobileNumber: {
            codeRegion: this.updatedSecondPhone?.codeRegion ? this.updatedSecondPhone?.codeRegion : null,
            phone: this.updatedSecondPhone?.phone ? this.updatedSecondPhone?.phone : null,
            fullPhone: this.updatedSecondPhone?.fullPhone ? this.updatedSecondPhone?.fullPhone : null,
          },
          socialNetwork: {
            instagram: instagram || null,
            twitter: twitter || null,
            linkedin: linkedin || null,
            facebook: facebook || null,
          },
        },
      };
      if (!this.updatedSecondPhone.fullPhone) payload.additionalInfo.secondMobileNumber = null;
      await this.editProfileResponse(`user/${this.editProfileRoute()}`, this.userRole === UserRole.WORKER ? {
        ...payload,
        additionalInfo: {
          ...payload.additionalInfo,
          educations: addInfo.educations,
          workExperiences: addInfo.workExperiences,
          description: addInfo.description || null,
        },
        workplace: this.parseDistantWork(this.skills.distantIndex),
        priority: this.skills.priorityIndex,
        wagePerHour: this.skills.perHour || this.userData.wagePerHour,
        specializationKeys: this.skills.selectedSpecAndSkills || [],
      } : {
        ...payload,
        additionalInfo: {
          ...payload.additionalInfo,
          description: addInfo.description || null,
          company: addInfo.company || null,
          CEO: addInfo.CEO || null,
          website: addInfo.website || null,
        },
      });
      await this.$store.dispatch('user/getUserData');
    },

    parseDistantWork(index) {
      if (index === 0) return 'distant';
      if (index === 1) return 'office';
      if (index === 2) return 'both';
      return null;
    },

    async editProfileResponse(action, payload) {
      await this.$store.dispatch(action, payload);
      this.showModalStatus('saved');
    },
  },
};
</script>

<style lang="scss" scoped>
.settings {
  @include main;
    display: grid;
    justify-items: center;
    grid-template-columns: 1fr;
    gap: 20px;
    margin: 20px 0 41px;
  &__title {
    max-width: 1180px;
    width: 100%;
    font-family: Inter, Arial, sans-serif;
    font-weight: 500;
    font-size: 25px;
    line-height: 32px;
    color: $black800;
  }
  &__body {
    display: grid;
    gap: 20px;
  }
}
@include _1199 {
  .settings {
    margin: 20px 20px 41px;
  }
}
@include _575 {
  .settings {
    margin: 20px 0 41px;
    width: 100%;
  }
}
</style>
